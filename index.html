<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Otaku Universe | Anime News & Global Community</title>
    
    <meta name="google-adsense-account" content="ca-pub-2452290332411403">
    
    <meta name="description" content="The #1 Global Platform for Anime & Manga fans. Join the Otaku Universe community for breaking news, discussions, and theories.">
    <meta name="keywords" content="Anime, Manga, Otaku Universe, Anime News, Community, One Piece, Attack on Titan, Naruto, Anime Forum">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="Otaku Universe Admin">
    <meta name='admaven-placement' content='Bqjw6qjU9'>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        /* --- Theme Variables --- */
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --accent: #ff3e3e;
            --dark-bg: #050507;
            --card-bg: #12121b;
            --text-main: #ffffff;
            --text-dim: #b3b3b3;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --glass: rgba(18, 18, 27, 0.95);
        }

        body.light-mode {
            --dark-bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1e272e;
            --text-dim: #57606f;
            --border: 1px solid rgba(0, 0, 0, 0.1);
            --glass: rgba(255, 255, 255, 0.95);
        }

        /* --- Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        
        body { 
            background-color: var(--dark-bg); 
            color: var(--text-main); 
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* --- Navigation Bar --- */
        nav {
            background: var(--glass); backdrop-filter: blur(15px);
            height: 55px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; position: fixed; width: 100%; top: 0; z-index: 1000;
            border-bottom: 2px solid var(--primary);
        }
        .brand { font-size: 24px; font-weight: 900; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        .nav-links { display: flex; gap: 30px; }
        .nav-link { cursor: pointer; color: var(--text-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .nav-link.active, .nav-link:hover { color: var(--primary); }

        .nav-actions { display: flex; align-items: center; gap: 20px; }
        .theme-toggle { font-size: 20px; cursor: pointer; color: var(--primary); }
        
        .user-nav-box { 
            display: none; align-items: center; gap: 12px; 
            background: rgba(108, 92, 231, 0.15); padding: 6px 18px; 
            border-radius: 40px; border: 1px solid var(--primary);
        }
        .user-nav-box img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .user-nav-box span { font-weight: 700; font-size: 14px; }

        /* --- Layout Structure --- */
        .main-wrapper { 
            max-width: 1400px; 
            margin: 110px auto 50px; 
            padding: 0 20px; 
            display: grid; 
            grid-template-columns: 80px 1fr; 
            gap: 40px; 
        }

        .main-wrapper.full-width {
            grid-template-columns: 1fr;
            max-width: 1000px;
        }
        
        /* Sidebar (Flags) */
        .server-rail {
            background: var(--card-bg); border-radius: 40px; padding: 25px 0;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            height: fit-content; position: sticky; top: 110px; border: var(--border);
        }
        
        /* Mobile Top Bar (Flags) - MODIFIED HERE */
        .mobile-server-bar {
            display: none; 
            overflow-x: auto; white-space: nowrap; gap: 15px; padding: 10px 20px;
            /* Changed margin-top from 80px to 115px to push buttons down */
            margin-top: 115px; 
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .server-btn { width: 50px; height: 50px; border-radius: 15px; cursor: pointer; overflow: hidden; border: 2px solid transparent; flex-shrink: 0; }
        .server-btn.active { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 15px var(--primary); }
        .server-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* --- News Section --- */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .news-card { 
            background: var(--card-bg); border-radius: 20px; overflow: hidden; border: var(--border);
            cursor: pointer; position: relative;
        }
        .news-card:hover { transform: translateY(-10px); border-color: var(--primary); }
        .news-img { width: 100%; height: 200px; object-fit: cover; }
        .news-info { padding: 20px; }
        .news-info h3 { margin-bottom: 10px; font-size: 18px; }
        .news-info p { color: var(--text-dim); font-size: 14px; line-height: 1.6; }

        /* --- FORUM & CONTACT STYLES --- */
        #forum-section, #contact-section {
            width: 100%;
        }

        .forum-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

        .post-card {
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 20px; 
            border: var(--border);
            margin-bottom: 25px; 
            cursor: pointer;
            width: 100%;
        }
        .post-card:hover { background: rgba(108, 92, 231, 0.05); border-color: var(--primary); }
        .post-card h3 { font-size: 22px; margin-bottom: 10px; }
        .post-meta { display: flex; gap: 20px; margin-top: 15px; font-size: 13px; color: var(--text-dim); }
        .post-meta span { display: flex; align-items: center; gap: 6px; }

        /* Contact Form */
        .contact-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            border: var(--border);
        }

        /* --- Detail View --- */
        .detail-view { display: none; }
        .back-btn { display: inline-flex; align-items: center; gap: 10px; color: var(--primary); cursor: pointer; margin-bottom: 25px; font-weight: 700; }
        .post-body { background: var(--card-bg); padding: 40px; border-radius: 25px; border: var(--border); }
        .post-body h1 { margin-bottom: 20px; font-size: 32px; }
        .post-image { width: 100%; max-height: 500px; object-fit: cover; border-radius: 15px; margin-bottom: 25px; }

        .reactions-bar { display: flex; gap: 25px; margin: 30px 0; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; }
        .react-btn { cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 18px; color: var(--text-dim); }
        .react-btn:hover, .react-btn.active { color: var(--primary); }

        /* --- Comments --- */
        .comments-box { margin-top: 40px; }
        .comment-item { 
            display: flex; gap: 15px; background: var(--card-bg); padding: 20px; 
            border-radius: 15px; margin-bottom: 15px; border: var(--border); border-left: 4px solid var(--primary);
        }
        .comment-item img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .comment-data h4 { font-size: 15px; color: var(--primary); margin-bottom: 5px; }
        .comment-data p { font-size: 14px; color: var(--text-main); }

        /* --- Modals & Inputs --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            display: none; justify-content: center; align-items: center; z-index: 5000; padding: 20px;
        }
        .modal-content { 
            background: var(--card-bg); width: 100%; max-width: 500px; padding: 35px; 
            border-radius: 25px; border: 1px solid var(--primary); position: relative; text-align: center;
            max-height: 90vh; overflow-y: auto;
        }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 8px; }
        .input-group input, .input-group textarea { 
            width: 100%; padding: 14px; background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); border-radius: 12px; color: white; outline: none;
        }
        .input-group input:focus { border-color: var(--primary); }
        .main-btn { 
            width: 100%; padding: 15px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 16px;
        }
        
        .avatar-picker {
            width: 110px; height: 110px; border-radius: 50%; border: 3px dashed var(--primary);
            margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; background: #000;
        }
        .avatar-picker img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-picker i { font-size: 30px; color: var(--primary); }

        .admin-plus {
            position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px;
            background: var(--primary); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 26px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 3000;
        }

        /* --- Mobile Bottom Navigation --- */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--glass); backdrop-filter: blur(20px);
            border-top: 1px solid var(--primary);
            justify-content: space-around; padding: 15px 0; z-index: 4000;
        }
        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            color: var(--text-dim); font-size: 12px; cursor: pointer;
        }
        .mobile-nav-item i { font-size: 20px; }
        .mobile-nav-item.active { color: var(--primary); }


        /* --- RESPONSIVE ADJUSTMENTS (THE FIX) --- */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            
            /* !important Ensures JS doesn't override it easily */
            .server-rail { display: none !important; } 
            
            .mobile-nav { display: flex; }

            .main-wrapper { 
                display: block; /* Fix grid issues on mobile */
                margin-top: 20px;
                margin-bottom: 90px;
                padding: 0 15px;
                width: 100%;
            }
            
            .news-grid { grid-template-columns: 1fr; }
            
            .post-body { padding: 20px; }
            .post-body h1 { font-size: 24px; }
            
            .admin-plus { bottom: 90px; right: 20px; width: 50px; height: 50px; font-size: 20px; }

            .forum-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            .forum-header button { width: 100%; }

            .post-card {
                padding: 20px;
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <nav>
        <div class="brand"><i class="fas fa-bolt"></i> OTAKU<span>UNIVERSE</span></div>
        <div class="nav-links">
            <div class="nav-link active" onclick="switchTab('news')">News</div>
            <div class="nav-link" onclick="switchTab('forum')">Community</div>
            <div class="nav-link" onclick="switchTab('contact')">Contact</div>
        </div>
        <div class="nav-actions">
            <div class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon" id="t-icon"></i></div>
            <button id="login-trigger" class="main-btn" style="width:auto; padding:8px 20px" onclick="openModal('login-modal')">Login</button>
            <div id="user-display" class="user-nav-box">
                <span id="nav-username"></span>
                <img id="nav-avatar" src="">
                <i class="fas fa-sign-out-alt" onclick="executeLogout()" style="margin-left:10px; cursor:pointer; color:var(--accent)" title="Logout"></i>
            </div>
        </div>
    </nav>

    <div class="mobile-server-bar" id="mobile-rail-id">
        <div class="server-btn active" onclick="switchServer('us', this)"><img src="https://flagcdn.com/w80/us.png"></div>
        <div class="server-btn" onclick="switchServer('sa', this)"><img src="https://flagcdn.com/w80/sa.png"></div>
        <div class="server-btn" onclick="switchServer('jp', this)"><img src="https://flagcdn.com/w80/jp.png"></div>
        <div class="server-btn" onclick="switchServer('es', this)"><img src="https://flagcdn.com/w80/es.png"></div>
    </div>

    <div class="admin-plus" onclick="openModal('admin-verify-modal')"><i class="fas fa-plus"></i></div>

    <div class="main-wrapper" id="main-wrapper-id">
        <aside class="server-rail" id="desktop-rail-id">
            <div class="server-btn active" onclick="switchServer('us', this)"><img src="https://flagcdn.com/w80/us.png"></div>
            <div class="server-btn" onclick="switchServer('sa', this)"><img src="https://flagcdn.com/w80/sa.png"></div>
            <div class="server-btn" onclick="switchServer('jp', this)"><img src="https://flagcdn.com/w80/jp.png"></div>
            <div class="server-btn" onclick="switchServer('es', this)"><img src="https://flagcdn.com/w80/es.png"></div>
        </aside>

        <main id="main-content-area">
            
            <div id="interface-us" class="server-view-container tab-content">
                <h1 style="margin-bottom: 30px;">US Server Updates</h1>
                <div id="news-container-us" class="news-grid"></div>
                <div id="news-reader-us" class="detail-view">
                    <div class="back-btn" onclick="closeNewsReader()"><i class="fas fa-arrow-left"></i> Back to News</div>
                    <div class="post-body">
                        <h1 id="nr-title-us"></h1>
                        <img id="nr-img-us" class="post-image">
                        <p id="nr-desc-us" style="white-space: pre-wrap; line-height: 1.8; color: var(--text-dim);"></p>
                    </div>
                </div>
            </div>

            <div id="interface-sa" class="server-view-container tab-content" style="display:none">
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <img src="https://flagcdn.com/w80/sa.png" style="width:50px; border-radius:10px;">
                    <h2>ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ÿßŸÑÿπÿ±ÿ®Ÿä</h2>
                </div>
                <div id="news-container-sa" class="news-grid"></div>
                <div id="news-reader-sa" class="detail-view" style="text-align:right">
                    <div class="back-btn" onclick="closeNewsReader()"><i class="fas fa-arrow-right"></i> ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿ£ÿÆÿ®ÿßÿ±</div>
                    <div class="post-body">
                        <h1 id="nr-title-sa"></h1>
                        <img id="nr-img-sa" class="post-image">
                        <p id="nr-desc-sa" style="white-space: pre-wrap; line-height: 1.8; color: var(--text-dim);"></p>
                    </div>
                </div>
            </div>

            <div id="interface-jp" class="server-view-container tab-content" style="display:none">
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <img src="https://flagcdn.com/w80/jp.png" style="width:50px; border-radius:10px;">
                    <h2>Japan Server News</h2>
                </div>
                <div id="news-container-jp" class="news-grid"></div>
                <div id="news-reader-jp" class="detail-view">
                    <div class="back-btn" onclick="closeNewsReader()"><i class="fas fa-arrow-left"></i> Back</div>
                    <div class="post-body">
                        <h1 id="nr-title-jp"></h1>
                        <img id="nr-img-jp" class="post-image">
                        <p id="nr-desc-jp" style="white-space: pre-wrap; line-height: 1.8; color: var(--text-dim);"></p>
                    </div>
                </div>
            </div>

            <div id="interface-es" class="server-view-container tab-content" style="display:none">
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                    <img src="https://flagcdn.com/w80/es.png" style="width:50px; border-radius:10px;">
                    <h2>Servidor Espa√±a</h2>
                </div>
                <div id="news-container-es" class="news-grid"></div>
                <div id="news-reader-es" class="detail-view">
                    <div class="back-btn" onclick="closeNewsReader()"><i class="fas fa-arrow-left"></i> Volver</div>
                    <div class="post-body">
                        <h1 id="nr-title-es"></h1>
                        <img id="nr-img-es" class="post-image">
                        <p id="nr-desc-es" style="white-space: pre-wrap; line-height: 1.8; color: var(--text-dim);"></p>
                    </div>
                </div>
            </div>

            <section id="forum-section" class="tab-content" style="display:none">
                <div id="forum-main-ui">
                    <div class="forum-header">
                        <h2><i class="fas fa-users"></i> Global Community</h2>
                        <button class="main-btn" style="width:auto" onclick="openModal('create-post-modal')">Start Thread</button>
                    </div>
                    <div id="forum-feed"></div>
                </div>

                <div id="forum-detail-ui" class="detail-view">
                    <div class="back-btn" onclick="closeThread()"><i class="fas fa-arrow-left"></i> Back to Community</div>
                    <div id="thread-content" class="post-body"></div>
                    
                    <div class="reactions-bar">
                        <div class="react-btn" onclick="updateReaction('like')" id="btn-like"><i class="fas fa-heart"></i> <span id="like-total">0</span></div>
                        <div class="react-btn" onclick="updateReaction('dislike')" id="btn-dislike"><i class="fas fa-heart-broken"></i> <span id="dislike-total">0</span></div>
                    </div>

                    <div class="comments-box">
                        <h3>Discussion</h3>
                        <div id="comments-render" style="margin-top: 20px;"></div>
                        <div class="input-group" style="margin-top:30px">
                            <textarea id="comment-text" placeholder="Share your thoughts..." rows="3"></textarea>
                            <button class="main-btn" style="margin-top:15px" onclick="postComment()">Post Comment</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="contact-section" class="tab-content" style="display:none; position: relative;">
                <div class="contact-container">
                    <div style="position: absolute; top: 0; right: 0; cursor: pointer; color: var(--primary); font-size: 24px;" onclick="switchTab('news')">
                        <i class="fas fa-times"></i>
                    </div>
                    <h1 style="text-align: center; margin-bottom: 20px;"><i class="fas fa-headset"></i> Contact Support</h1>
                    <p style="color:var(--text-dim); margin-bottom:30px; text-align: center;">We are here to help you.</p>
                    
                    <div class="input-group"><input type="text" id="c-name" placeholder="Your Name"></div>
                    <div class="input-group"><input type="email" id="c-email" placeholder="Your Email"></div>
                    <div class="input-group"><textarea id="c-msg" placeholder="Your Message" rows="5"></textarea></div>
                    <button class="main-btn" onclick="sendContactMail()">Send Message</button>
                </div>
            </section>

        </main>
    </div>

    <div class="mobile-nav">
        <div class="mobile-nav-item active" onclick="switchTab('news'); updateMobileNav(this)">
            <i class="fas fa-newspaper"></i>
            <span>News</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('forum'); updateMobileNav(this)">
            <i class="fas fa-comments"></i>
            <span>Community</span>
        </div>
        <div class="mobile-nav-item" onclick="switchTab('contact'); updateMobileNav(this)">
            <i class="fas fa-envelope"></i>
            <span>Contact</span>
        </div>
    </div>

    <div class="modal-overlay" id="login-modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position:absolute; top:20px; right:25px; cursor:pointer" onclick="closeAllModals()"></i>
            <h2>Welcome Back</h2>
            <div class="input-group" style="margin-top:30px">
                <input type="email" id="log-email" placeholder="Email Address">
                <input type="password" id="log-pass" placeholder="Password" style="margin-top:15px">
            </div>
            <button class="main-btn" onclick="executeLogin()">Login</button>
            <p style="margin-top:20px; font-size:13px; color:var(--text-dim)">
                <span onclick="openModal('forgot-modal')" style="color:var(--primary); cursor:pointer">Forgot Password?</span>
            </p>
            <p style="margin-top:15px; font-size:14px">
                New here? <span onclick="openModal('reg-modal')" style="color:var(--primary); cursor:pointer; font-weight:700">Create Account</span>
            </p>
        </div>
    </div>

    <div class="modal-overlay" id="reg-modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position:absolute; top:20px; right:25px; cursor:pointer" onclick="closeAllModals()"></i>
            <h2>Join the Universe</h2>
            <div class="avatar-picker" onclick="document.getElementById('avatar-input').click()">
                <i class="fas fa-user-plus" id="avatar-icon"></i>
                <img id="avatar-preview" src="">
            </div>
            <input type="file" id="avatar-input" hidden accept="image/*" onchange="processAvatar(this)">
            <div class="input-group">
                <input type="text" id="reg-name" placeholder="Display Name">
                <input type="email" id="reg-email" placeholder="Email Address" style="margin-top:15px">
                <input type="password" id="reg-pass" placeholder="Password" style="margin-top:15px">
            </div>
            <button class="main-btn" onclick="executeRegister()">Sign Up</button>
        </div>
    </div>

    <div class="modal-overlay" id="forgot-modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position:absolute; top:20px; right:25px; cursor:pointer" onclick="closeAllModals()"></i>
            <div id="step-1">
                <h3>Reset Password</h3>
                <p style="color:var(--text-dim); margin:15px 0; font-size:14px">Enter your email to receive recovery code</p>
                <div class="input-group"><input type="email" id="reset-email" placeholder="Email Address"></div>
                <button class="main-btn" onclick="sendFirebaseOTP()">Send Code</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="admin-verify-modal">
        <div class="modal-content">
            <h3>Admin Access</h3>
            <div class="input-group" style="margin-top:20px">
                <input type="password" id="admin-pass" placeholder="System Password">
            </div>
            <button class="main-btn" onclick="checkAdmin()">Verify</button>
        </div>
    </div>

    <div class="modal-overlay" id="admin-news-modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position:absolute; top:20px; right:25px; cursor:pointer" onclick="closeAllModals()"></i>
            <h3>Publish News</h3>
            <p style="font-size:12px; color:var(--primary); margin-bottom:10px" id="server-target-display"></p>
            <div class="input-group"><label>Title</label><input type="text" id="n-title"></div>
            <div class="input-group"><label>Image</label><input type="file" id="n-file" accept="image/*"></div>
            <div class="input-group"><label>Content</label><textarea id="n-desc" rows="4"></textarea></div>
            <button class="main-btn" onclick="saveNews()">Publish Now</button>
        </div>
    </div>

    <div class="modal-overlay" id="create-post-modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position:absolute; top:20px; right:25px; cursor:pointer" onclick="closeAllModals()"></i>
            <h2>New Thread</h2>
            <div class="input-group"><label>Thread Title</label><input type="text" id="p-title"></div>
            <div class="input-group"><label>Banner (Optional)</label><input type="file" id="p-file" accept="image/*"></div>
            <div class="input-group"><label>Description</label><textarea id="p-desc" rows="5"></textarea></div>
            <button class="main-btn" onclick="saveThread()">Create Thread</button>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        const firebaseConfig = {
            apiKey: "AIzaSyD6YYVOkPI1TJEExWMXcAdUabCENXx5gYY",
            authDomain: "news-server-fff75.firebaseapp.com",
            projectId: "news-server-fff75",
            storageBucket: "news-server-fff75.firebasestorage.app",
            messagingSenderId: "420540242806",
            appId: "1:420540242806:web:0fa1e10f18fe57b64e7857"
        };
        
        const TG_TOKEN = "8584369176:AAF7_akcyjXyic2MG7cd1Xx4JgB2uOpJ7ok";
        const TG_CHAT_ID = "8555282633";

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        /* --- APP STATE --- */
        let currentUser = null;
        let currentServer = 'us'; 
        
        // Demo Data (Fallback)
        let defaultNews = [
            {id: 1, title: "Attack on Titan: Final Chapter News", img: "https://images.alphacoders.com/133/1330360.png", desc: "The studio announced the last part of the final season...", server: 'us'}
        ];
        let defaultThreads = [
            {id: 101, user: "Admin", title: "Best Anime of 2024?", desc: "Let's discuss the top rankings for this year's winter season.", img: "", likes: 15, dislikes: 2, comments: [], userReactions: {}}
        ];

        let newsData = [];
        let threads = [];
        let activeThread = null;

        function loadDataFromStorage() {
            const storedNews = localStorage.getItem('otaku_news_data');
            newsData = storedNews ? JSON.parse(storedNews) : defaultNews;

            const storedThreads = localStorage.getItem('otaku_threads_data');
            threads = storedThreads ? JSON.parse(storedThreads) : defaultThreads;
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                const storedAvatar = localStorage.getItem('user_avatar_' + user.email);
                currentUser = { 
                    name: user.displayName || "User", 
                    email: user.email,
                    avatar: storedAvatar || user.photoURL || "https://via.placeholder.com/100" 
                };
                updateUserUI();
            } else {
                currentUser = null;
                document.getElementById('login-trigger').style.display = 'block';
                document.getElementById('user-display').style.display = 'none';
            }
        });

        /* --- UI LOGIC --- */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

            const rail = document.getElementById('desktop-rail-id');
            const mobileRail = document.getElementById('mobile-rail-id');
            const wrapper = document.getElementById('main-wrapper-id');

            if (tabId === 'news') {
                // Show News
                document.getElementById('interface-' + currentServer).style.display = 'block';
                document.querySelectorAll('.nav-link')[0].classList.add('active');
                
                // --- FIX: Don't force 'flex', let CSS handle it via Media Queries ---
                if(rail) rail.style.display = ''; 
                
                // Show mobile rail ONLY if screen is small
                if(mobileRail) {
                    if(window.innerWidth <= 768) mobileRail.style.display = 'flex';
                    else mobileRail.style.display = 'none';
                }
                
                wrapper.classList.remove('full-width');

            } else if (tabId === 'forum') {
                // Show Community
                document.getElementById('forum-section').style.display = 'block';
                document.querySelectorAll('.nav-link')[1].classList.add('active');
                
                // Hide Flags & Go Full Width
                if(rail) rail.style.display = 'none';
                if(mobileRail) mobileRail.style.display = 'none';
                wrapper.classList.add('full-width');

            } else if (tabId === 'contact') {
                // Show Contact
                document.getElementById('contact-section').style.display = 'block';
                document.querySelectorAll('.nav-link')[2].classList.add('active');
                
                // Hide Flags & Go Full Width
                if(rail) rail.style.display = 'none';
                if(mobileRail) mobileRail.style.display = 'none';
                wrapper.classList.add('full-width');
            }
        }
        
        function updateMobileNav(element) {
            document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
        }

        function switchServer(serverId, btn) {
            document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentServer = serverId;
            switchTab('news'); 
            renderNews();
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('t-icon');
            icon.className = document.body.classList.contains('light-mode') ? 'fas fa-sun' : 'fas fa-moon';
        }

        /* --- AUTH --- */
        function processAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('avatar-preview').src = e.target.result;
                    document.getElementById('avatar-preview').style.display = 'block';
                    document.getElementById('avatar-icon').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function executeRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const pfp = document.getElementById('avatar-preview').src;
            
            if(!name || !email || !pass) return alert("Please fill all fields!");
            if(pfp === "" || pfp.includes("window.location")) return alert("Please select an avatar!");

            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    localStorage.setItem('user_avatar_' + email, pfp);
                    userCredential.user.updateProfile({ displayName: name }).then(() => {
                        currentUser = { name: name, email: email, avatar: pfp };
                        sendTextToTelegram(`üÜï ÿ™ÿ≥ÿ¨ŸäŸÑ ÿπÿ∂Ÿà ÿ¨ÿØŸäÿØ:\nüë§ ÿßŸÑÿßÿ≥ŸÖ: ${name}\nüìß ÿßŸÑÿ•ŸäŸÖŸäŸÑ: ${email}`);
                        updateUserUI();
                        closeAllModals();
                        alert("Account created! Welcome " + name);
                    });
                })
                .catch((error) => { alert("Error: " + error.message); });
        }

        function executeLogin() {
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            if(!email || !pass) return alert("Please enter email and password");

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => { closeAllModals(); })
                .catch((error) => { alert("Login Failed: " + error.message); });
        }

        function executeLogout() {
            auth.signOut().then(() => { window.location.reload(); });
        }

        function updateUserUI() {
            if(currentUser) {
                document.getElementById('login-trigger').style.display = 'none';
                document.getElementById('user-display').style.display = 'flex';
                document.getElementById('nav-username').innerText = currentUser.name;
                document.getElementById('nav-avatar').src = currentUser.avatar;
            }
        }

        function sendFirebaseOTP() {
            const email = document.getElementById('reset-email').value;
            if(!email) return alert("Enter email first");
            auth.sendPasswordResetEmail(email)
                .then(() => { alert("Password reset email sent!"); closeAllModals(); })
                .catch((error) => { alert("Error: " + error.message); });
        }

        function sendContactMail() {
            const name = document.getElementById('c-name').value;
            const email = document.getElementById('c-email').value;
            const msg = document.getElementById('c-msg').value;
            if(!name || !email || !msg) { alert("Please fill in all fields"); return; }
            sendTextToTelegram(`üì© ÿ±ÿ≥ÿßŸÑÿ© ÿØÿπŸÖ ŸÅŸÜŸä ÿ¨ÿØŸäÿØÿ©:\n\nüë§ ŸÖŸÜ: ${name}\nüìß ÿßŸÑÿ•ŸäŸÖŸäŸÑ: ${email}\nüìù ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ: ${msg}`);
            alert("Message Sent!");
        }

        /* --- DATA HANDLING --- */
        function renderNews() {
            const containerId = `news-container-${currentServer}`;
            const container = document.getElementById(containerId);
            if(container) {
                const filteredNews = newsData.filter(n => n.server === currentServer);
                if(filteredNews.length === 0) {
                    container.innerHTML = `<p style="color:var(--text-dim); text-align:center; grid-column:1/-1;">No news yet in this region.</p>`;
                } else {
                    container.innerHTML = filteredNews.map(n => `
                        <div class="news-card" onclick="openNewsDetail(${n.id})">
                            <img src="${n.img}" class="news-img">
                            <div class="news-info">
                                <h3>${n.title}</h3>
                                <p>${n.desc.substring(0, 100)}...</p>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function openNewsDetail(id) {
            const newsItem = newsData.find(n => n.id === id);
            if(!newsItem) return;
            document.getElementById(`news-container-${currentServer}`).style.display = 'none';
            document.getElementById(`nr-title-${currentServer}`).innerText = newsItem.title;
            document.getElementById(`nr-img-${currentServer}`).src = newsItem.img;
            document.getElementById(`nr-desc-${currentServer}`).innerText = newsItem.desc;
            document.getElementById(`news-reader-${currentServer}`).style.display = 'block';
            window.scrollTo(0,0);
        }

        function closeNewsReader() {
            const reader = document.getElementById(`news-reader-${currentServer}`);
            const grid = document.getElementById(`news-container-${currentServer}`);
            if(reader && grid) { reader.style.display = 'none'; grid.style.display = 'grid'; }
        }

        async function saveNews() {
            const title = document.getElementById('n-title').value;
            const desc = document.getElementById('n-desc').value;
            const fileInput = document.getElementById('n-file');
            const file = fileInput.files[0];
            let imgDisplay = "https://via.placeholder.com/400x200";

            if(!title || !desc) return alert("Please add title and description");

            if(file) {
                 const caption = `üî• ÿÆÿ®ÿ± ÿ¨ÿØŸäÿØ (${currentServer.toUpperCase()}):\n\nüìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${title}\nüìÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ${desc}`;
                 const telegramImgUrl = await uploadToTelegramAndGetURL(file, caption);
                 if(telegramImgUrl) imgDisplay = telegramImgUrl;
            } else {
                sendTextToTelegram(`üî• ÿÆÿ®ÿ± ÿ¨ÿØŸäÿØ (${currentServer.toUpperCase()}):\n\nüìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${title}\nüìÑ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ${desc}`);
            }

            newsData.unshift({ id: Date.now(), title, desc, img: imgDisplay, server: currentServer });
            localStorage.setItem('otaku_news_data', JSON.stringify(newsData));
            renderNews(); closeAllModals();
        }

        /* --- FORUM LOGIC --- */
        function renderForum() {
            const feed = document.getElementById('forum-feed');
            feed.innerHTML = threads.map(t => `
                <div class="post-card" onclick="openThread(${t.id})">
                    <h3>${t.title}</h3>
                    <div class="post-meta">
                        <span><i class="fas fa-user"></i> ${t.user}</span>
                        <span><i class="fas fa-comment"></i> ${t.comments.length}</span>
                        <span><i class="fas fa-heart"></i> ${t.likes}</span>
                    </div>
                </div>
            `).join('');
        }

        function openThread(id) {
            activeThread = threads.find(t => t.id === id);
            if (!activeThread.userReactions) activeThread.userReactions = {};

            document.getElementById('forum-main-ui').style.display = 'none';
            document.getElementById('forum-detail-ui').style.display = 'block';
            
            let imgPart = activeThread.img ? `<img src="${activeThread.img}" class="post-image">` : '';
            document.getElementById('thread-content').innerHTML = `<h1>${activeThread.title}</h1>${imgPart}<p>${activeThread.desc}</p>`;
            updateReactionUI(); renderComments();
        }

        function closeThread() {
            document.getElementById('forum-main-ui').style.display = 'block';
            document.getElementById('forum-detail-ui').style.display = 'none';
            activeThread = null;
        }

        function updateReaction(type) {
            if (!activeThread) return;
            if (!activeThread.userReactions) activeThread.userReactions = {};

            if (type === 'like') {
                if (activeThread.userReactions.liked) {
                    activeThread.likes--; activeThread.userReactions.liked = false;
                } else {
                    activeThread.likes++; activeThread.userReactions.liked = true;
                    if (activeThread.userReactions.disliked) { activeThread.dislikes--; activeThread.userReactions.disliked = false; }
                }
            } else if (type === 'dislike') {
                if (activeThread.userReactions.disliked) {
                    activeThread.dislikes--; activeThread.userReactions.disliked = false;
                } else {
                    activeThread.dislikes++; activeThread.userReactions.disliked = true;
                    if (activeThread.userReactions.liked) { activeThread.likes--; activeThread.userReactions.liked = false; }
                }
            }
            updateReactionUI();
            localStorage.setItem('otaku_threads_data', JSON.stringify(threads));
        }

        function updateReactionUI() {
            document.getElementById('like-total').innerText = activeThread.likes;
            document.getElementById('dislike-total').innerText = activeThread.dislikes;
            const likeBtn = document.getElementById('btn-like');
            const dislikeBtn = document.getElementById('btn-dislike');
            likeBtn.style.color = activeThread.userReactions.liked ? 'var(--primary)' : 'var(--text-dim)';
            dislikeBtn.style.color = activeThread.userReactions.disliked ? 'var(--accent)' : 'var(--text-dim)';
        }

        function postComment() {
            if(!currentUser) return openModal('login-modal');
            const text = document.getElementById('comment-text').value;
            if(!text) return;
            
            sendTextToTelegram(`üí¨ ÿ™ÿπŸÑŸäŸÇ ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿØŸâ:\nüìå ÿßŸÑŸÖŸàÿ∂Ÿàÿπ: ${activeThread.title}\nüë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${currentUser.name}\nüìù ÿßŸÑÿ™ÿπŸÑŸäŸÇ: ${text}`);

            activeThread.comments.push({ user: currentUser.name, avatar: currentUser.avatar, text: text });
            localStorage.setItem('otaku_threads_data', JSON.stringify(threads));
            document.getElementById('comment-text').value = '';
            renderComments(); renderForum();
        }

        function renderComments() {
            const box = document.getElementById('comments-render');
            box.innerHTML = activeThread.comments.map(c => `
                <div class="comment-item">
                    <img src="${c.avatar}">
                    <div class="comment-data">
                        <h4>${c.user}</h4>
                        <p>${c.text}</p>
                    </div>
                </div>
            `).join('');
        }

        async function saveThread() {
            if(!currentUser) {
                alert("You must be logged in to create a thread!");
                return openModal('login-modal');
            }

            const title = document.getElementById('p-title').value;
            const desc = document.getElementById('p-desc').value;
            const fileInput = document.getElementById('p-file');
            const file = fileInput.files[0];
            let imgUrl = "";
            
            if(!title || !desc) return;
            
            if(file) {
                 const caption = `üì¢ ŸÖŸàÿ∂Ÿàÿπ ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿØŸâ:\n\nüë§ ÿßŸÑŸÉÿßÿ™ÿ®: ${currentUser.name}\nüìå ÿßŸÑÿπŸÜŸàÿßŸÜ: ${title}\nüìù ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ: ${desc}`;
                 const tgUrl = await uploadToTelegramAndGetURL(file, caption);
                 if(tgUrl) imgUrl = tgUrl;
            } else {
                 sendTextToTelegram(`üì¢ ŸÖŸàÿ∂Ÿàÿπ ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿØŸâ:\n\nüë§ ÿßŸÑŸÉÿßÿ™ÿ®: ${currentUser.name}\nüìå ÿßŸÑÿπŸÜŸàÿßŸÜ: ${title}\nüìù ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ: ${desc}`);
            }

            threads.unshift({ 
                id: Date.now(), 
                user: currentUser.name, 
                title, 
                desc, 
                img: imgUrl, 
                likes: 0, 
                dislikes: 0, 
                comments: [], 
                userReactions: {} 
            });
            localStorage.setItem('otaku_threads_data', JSON.stringify(threads));
            renderForum(); closeAllModals();
        }

        function checkAdmin() {
            const p = document.getElementById('admin-pass').value;
            if(p === "admin.mc.ch") {
                closeAllModals();
                document.getElementById('server-target-display').innerText = "Publishing to: " + currentServer.toUpperCase() + " Server";
                openModal('admin-news-modal');
            } else { alert("Access Denied!"); }
        }

        /* --- HELPERS --- */
        function sendTextToTelegram(message) {
            const url = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${encodeURIComponent(message)}`;
            fetch(url).catch(err => console.error("Telegram Error:", err));
        }

        async function uploadToTelegramAndGetURL(file, caption) {
            const formData = new FormData();
            formData.append("chat_id", TG_CHAT_ID);
            formData.append("caption", caption);
            formData.append("photo", file);

            try {
                const response = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, {
                    method: "POST", body: formData
                });
                const data = await response.json();

                if (data.ok) {
                    const photos = data.result.photo;
                    const fileId = photos[photos.length - 1].file_id;
                    const fileRes = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/getFile?file_id=${fileId}`);
                    const fileData = await fileRes.json();
                    if (fileData.ok) {
                        return `https://api.telegram.org/file/bot${TG_TOKEN}/${fileData.result.file_path}`;
                    }
                }
            } catch (error) { console.error("Telegram Upload Error:", error); }
            return "";
        }

        function openModal(id) { closeAllModals(); document.getElementById(id).style.display = 'flex'; }
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }

        window.onload = () => { loadDataFromStorage(); renderNews(); renderForum(); };
    </script>
</body>
</html>
